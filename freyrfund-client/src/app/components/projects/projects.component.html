<app-navbar></app-navbar>

<div class="projects-container">
  <div class="header-flex">
    <h1 class="catalog-title">Catalogue de Projets</h1>
    <div class="header-right">
      <div class="search-input-container">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          placeholder="Rechercher des projets..."
          class="search-input"
        />
        <span class="search-icon"><i class="fas fa-search"></i></span>
      </div>
      <button (click)="openTopUpModal()" class="btn-topup">D√©p√¥t</button>
    </div>
  </div>

  <div class="search-info" *ngIf="!loading">
    <p>
      <span *ngIf="searchTerm">R√©sultats pour "<strong>{{searchTerm}}</strong>": </span>
      {{totalCount}} projet(s) trouv√©(s)
    </p>
  </div>

  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement des projets...</p>
  </div>

  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
    <button (click)="loadProjects()" class="retry-btn">Essayer √† nouveau</button>
  </div>

  <div *ngIf="!loading && !error" class="projects-content">
    <div class="projects-grid" *ngIf="projects.length > 0">
      <div *ngFor="let project of projects" class="project-card">
        <img [src]="getProjectImage(project)" alt="{{ project.title }}" class="project-image" />

        <div class="project-header">
          <h3 [title]="project.title">{{ project.title }}</h3>
          <div class="project-badges">
            <span class="badge risk-badge" [ngClass]="getRiskClass(project.risk)">
              {{ getRiskDescription(project.risk) }}
            </span>
            <span class="badge status-badge" [class.fully-funded]="project.isFullyFunded">
              <span *ngIf="project.isFullyFunded">‚úì Financ√© </span>
              <span *ngIf="!project.isFullyFunded">Actif</span>
            </span>
          </div>
        </div>

        <div class="project-details">
          <div class="detail-row"><span class="label">Taux de rendement:</span><span class="value">{{ project.rate }}%</span></div>
          <div class="detail-row"><span class="label">D√©lais:</span><span class="value">{{ project.term }} mois</span></div>
          <div class="detail-row"><span class="label">Objectif:</span><span class="value">{{ formatCurrency(project.target) }}</span></div>
          <div class="detail-row"><span class="label">Financ√©:</span><span class="value">{{ formatCurrency(project.funded) }}</span></div>
          <div class="detail-row"><span class="label">Montant restant √† investir:</span><span class="value">{{ formatCurrency(project.remainingAmount) }}</span></div>

          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="project.fundingPercentage"></div>
            </div>
            <span class="progress-text">{{ project.fundingPercentage | number:'1.1-1' }}%</span>
          </div>
        </div>

        <div class="project-actions">
          <div class="invest-full-row">
            <input type="number" [(ngModel)]="project.investmentAmount" min="1" [max]="project.remainingAmount" placeholder="Montant" [disabled]="project.isFullyFunded" />
            <button class="btn-invest" [disabled]="project.isFullyFunded || !project.investmentAmount" (click)="invest(project, project.investmentAmount || 0)">
              <span *ngIf="!project.isFullyFunded">Investir</span>
              <span *ngIf="project.isFullyFunded">Financ√©</span>
            </button>
          </div>
          <button class="btn-details" (click)="openModal(project)">Voir d√©tails</button>
        </div>

        <div class="project-footer">
          <small>Cr√©√© le: {{ project.createdAt | date:'dd/MM/yyyy' }}</small>
        </div>
      </div>
    </div>

    <div *ngIf="projects.length === 0" class="no-results">
      <div class="no-results-icon">üìã</div>
      <h3>Aucun projet trouv√©</h3>
      <p *ngIf="searchTerm">Essayez d'ajuster votre recherche ou <a href="#" (click)="searchTerm=''; onSearchChange()">r√©initialiser les filtres</a>.</p>
      <p *ngIf="!searchTerm">Aucun projet disponible pour le moment.</p>
    </div>

    <div class="pagination-container" *ngIf="totalPages > 1">
      <div class="pagination-info">
        <p>Page {{ currentPage }} de {{ totalPages }} ({{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalCount) }} de {{ totalCount }} projets)</p>
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" [disabled]="!hasPreviousPage" (click)="previousPage()">‚Äπ Ant√©rieure</button>
        <button *ngFor="let page of getPageNumbers()" class="pagination-btn page-number" [class.active]="page === currentPage" (click)="goToPage(page)">
          {{ page }}
        </button>
        <button class="pagination-btn" [disabled]="!hasNextPage" (click)="nextPage()">Prochaine ‚Ä∫</button>
      </div>
    </div>
  </div>
</div>


<div class="modal-overlay" *ngIf="selectedProject" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>{{ selectedProject.title }}</h2>
    <p>{{ selectedProject.description }}</p>
    <button class="modal-close" (click)="closeModal()">Fermer</button>
  </div>
</div>



<div class="modal-overlay" *ngIf="showTopUpModal" (click)="closeTopUpModal()">
  <div class="modal-content topup-modal" (click)="$event.stopPropagation()">
    <h2 class="modal-title">D√©poser des fonds</h2>
    <p class="modal-text"> Entrez le montant:</p>

    <input type="number" [(ngModel)]="topUpAmount" min="1" placeholder="Montant (‚Ç¨)" class="modal-input" />

    <div class="modal-actions">
      <button (click)="confirmTopUp()" class="btn btn-confirm">Confirmer</button>
      <button (click)="closeTopUpModal()" class="btn btn-cancel">Annuler</button>
    </div>
  </div>
</div>
